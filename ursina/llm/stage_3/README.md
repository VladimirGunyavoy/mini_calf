# Stage 3: Differential Drive System

Папка для работы агентов над добавлением дифференциального привода в проект CALF.

---

## Структура файлов

### `00_START_HERE.md` - Точка входа
**Назначение**: Стартовый промпт для нового агента.

**Содержит**:
- Краткий контекст задачи
- Критические правила работы
- Где искать информацию
- Команды для запуска
- Чеклист выполнения (галочки)

**Использование**: Скопируй путь к этому файлу и передай в новый диалог.

---

### `01_PLAN.md` - План с ТЗ
**Назначение**: Детальный план реализации с техническим заданием по каждому Part.

**Структура**:
- **Секция 1**: Краткий чеклист (8 частей с галочками)
- **Секция 2**: Подробное ТЗ для каждой части

**Части (Parts)**:
1. Part 1: Базовые абстракции (BaseEnv, BaseDynamicalSystem)
2. Part 2: DifferentialDriveEnv (RL среда)
3. Part 3: Номинальная политика (move-to-point)
4. Part 4: DifferentialDriveSystem (физика)
5. Part 5: OrientedAgent (визуализация cone)
6. Part 6: Интеграция (VectorizedEnv, Config)
7. Part 7: Интеграция main.py + CriticHeatmap
8. Part 8: Тестирование

**Использование**: Начни с первой незавершённой части, отмечай галочки по мере выполнения.

---

### `02_LESSONS_LEARNED.md` - Выученные уроки
**Назначение**: База знаний для будущих агентов.

**Формат**:
```
## Lesson N: [Дата] Название
**Проблема**: Что случилось
**Решение**: Как исправили
**Вывод**: Что запомнить
```

**Использование**: При решении проблемы - добавь новый урок в конец файла.

---

### `03_DECISIONS_LOG.md` - Принятые решения
**Назначение**: Документация архитектурных решений.

**Формат**:
```
## Decision N: [Дата] Название
**Контекст**: Почему нужно было решать
**Варианты**: Что рассматривали
**Выбор**: Что выбрали
**Обоснование**: Почему
**Последствия**: Что меняется
```

**Использование**: При выборе между несколькими вариантами - задокументируй решение.

---

### `PART_X_SUMMARY.md` - Итоги частей
**Назначение**: Создаются по ходу работы для каждой завершённой части.

**Формат**: Как файлы STAGE_X_SUMMARY.md в stage_2.

---

## Workflow для агента

### 1. Старт
```
1. Открыть 00_START_HERE.md
2. Прочитать контекст и правила
3. Открыть 01_PLAN.md
4. Найти первую незавершённую часть (Part)
```

### 2. Выполнение части
```
1. Прочитать ТЗ для части
2. Выполнить подзадачи
3. Отметить галочки в плане
4. Записать уроки в 02_LESSONS_LEARNED.md
5. Записать решения в 03_DECISIONS_LOG.md
6. Создать PART_X_SUMMARY.md с итогами
```

### 3. Проверка пользователем
```
1. Сообщить пользователю о завершении части
2. ДОЖДАТЬСЯ подтверждения: "работает, продолжай"
3. Если есть проблемы - исправить
4. Только после OK - переход к следующей части
```

### 4. Завершение Stage 3
```
1. Все 8 частей завершены (галочки проставлены)
2. Обновлён 00_START_HERE.md со статусом ЗАВЕРШЕНО
3. Проект поддерживает обе системы: point_mass и differential_drive
```

---

## Правила работы

### ЗАПРЕЩЕНО
- Переходить к следующей части без подтверждения пользователя
- Пропускать запись уроков и решений
- Забывать обновлять галочки в плане
- Ломать существующий код Point Mass

### ОБЯЗАТЕЛЬНО
- Читать ТЗ перед началом части
- Записывать уроки при решении проблем
- Документировать архитектурные решения
- Обновлять галочки после каждой подзадачи
- Тестировать что Point Mass ещё работает (регрессия)
- Ждать подтверждения перед следующей частью

---

## Связь с другими документами

### Из stage_2 (для reference)
- `../stage_2/02_LESSONS_LEARNED.md` - уроки из предыдущей стадии
- `../stage_2/03_DECISIONS_LOG.md` - решения из предыдущей стадии

### Ключевые файлы проекта
- `../../RL/simple_env.py` - текущая RL среда (Point Mass)
- `../../RL/calf.py` - CALFController (универсальный)
- `../../physics/point_system.py` - текущая физика
- `../../physics/vectorized_env.py` - векторизованная среда
- `../../visuals/critic_heatmap.py` - heatmap критика
- `../../config/training_config.py` - конфигурация
- `../../main.py` - точка входа

### Создаваемые файлы
- `../../RL/base_env.py` - базовый класс сред (Part 1)
- `../../RL/differential_drive_env.py` - новая среда (Part 2)
- `../../physics/base_system.py` - базовый класс физики (Part 4)
- `../../physics/differential_drive_system.py` - новая физика (Part 4)
- `../../visuals/oriented_agent.py` - cone визуализация (Part 5)
- `../../training/reward_plotter.py` - график reward в PNG (Post Stage 3)

---

## Метрики успеха Stage 3

### Функциональность
- [x] DifferentialDriveEnv создана и работает
- [x] Номинальная политика стабилизирует систему
- [x] Визуализация показывает ориентацию (cone)
- [x] Heatmap работает при theta=0

### Совместимость
- [x] Point Mass не сломан (регрессия)
- [x] Выбор системы через config/CLI
- [x] Обе системы обучаются с CALF

### Архитектура
- [x] Базовые классы (BaseEnv, BaseDynamicalSystem)
- [x] Легко добавить третью систему в будущем

### Дополнительно (Post Stage 3)
- [x] RewardPlotter - график reward сохраняется в `plots/reward_plot.png`
- [x] Баг add_visual_agent() исправлен для differential_drive

---

## Математическая модель

### Differential Drive (Unicycle)
```
State:  [x, y, θ]      - позиция + ориентация
Action: [v, ω]         - линейная + угловая скорость

Dynamics:
  ẋ = v · cos(θ)
  ẏ = v · sin(θ)
  θ̇ = ω

Цель: стабилизация в [0, 0, 0]
```

### Визуализация
- Агент: **cone** (конус) с ориентацией θ
- Heatmap: срез при **θ=0**
- Координаты: x→X, y→Z в Ursina

---

**Удачи в Stage 3!**
