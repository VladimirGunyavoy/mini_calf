# Stage 4: Performance Optimization üöÄ

## –¶–µ–ª—å
–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ CALF –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –∞–Ω–∏–º–∞—Ü–∏–∏.

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ Stage 3 –≤—ã—è–≤–ª–µ–Ω—ã —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
1. **GPU queries –¥–ª—è height computation** - —á–∞—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã critic –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä
2. **Per-agent loops** - –º–Ω–æ–≥–æ —Ü–∏–∫–ª–æ–≤ Python –≤–º–µ—Å—Ç–æ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ NumPy
3. **UI updates** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## –¢—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### üî¥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: Vectorized Height Computation
**–§–∞–π–ª**: `ursina/visuals/critic_heatmap.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
- `get_q_value_for_states_batch()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Python —Ü–∏–∫–ª –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
- –ö–∞–∂–¥—ã–π visual agent –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ü—Ä–∏ N=20 –∞–≥–µ–Ω—Ç–∞—Ö ‚Üí 20 –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ + 20 height computations

**–†–µ—à–µ–Ω–∏–µ**:
- –ü–æ–ª–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è bilinear interpolation —Å NumPy
- Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ –æ–¥–Ω–∏–º –≤—ã–∑–æ–≤–æ–º
- –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ grid indices –¥–ª—è –≤—Å–µ–≥–æ batch

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:
- 5-10x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–∏ N > 10 –∞–≥–µ–Ω—Ç–æ–≤
- –°–Ω–∏–∂–µ–Ω–∏–µ CPU load –Ω–∞ 40-60%

---

### üü† –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Lazy Stats Computation with Caching
**–§–∞–π–ª**: `ursina/training/visualizer.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
- `update_stats_display()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä (60 FPS)
- –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –¥–µ–ª–∞–µ—Ç GPU query –¥–ª—è Q-value —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (episode reward, P_relax) –º–µ–Ω—è—é—Ç—Å—è —Ä–µ–¥–∫–æ

**–†–µ—à–µ–Ω–∏–µ**:
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
- Dirty flag –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (new episode, policy update)
- Configurable update frequency –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö –º–µ—Ç—Ä–∏–∫

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:
- 50-70% —Å–Ω–∏–∂–µ–Ω–∏–µ GPU queries
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ UI update —Å ~2ms –¥–æ ~0.1ms

---

### üü† –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: Batched Trail Mesh Updates
**–§–∞–π–ª**: `ursina/visuals/line_trail.py`, `ursina/training/visualizer.py`

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ö–∞–∂–¥—ã–π `VisualAgent` –∏–º–µ–µ—Ç —Å–≤–æ–π `LineTrail`
- –ö–∞–∂–¥—ã–π trail rebuild ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π GPU mesh update
- –ü—Ä–∏ N=20 –∞–≥–µ–Ω—Ç–∞—Ö ‚Üí 20 mesh updates –∑–∞ –∫–∞–¥—Ä (–µ—Å–ª–∏ –≤—Å–µ –¥–≤–∏–≥–∞—é—Ç—Å—è)

**–†–µ—à–µ–Ω–∏–µ**:
- `BatchedTrailRenderer` - –µ–¥–∏–Ω—ã–π mesh –¥–ª—è –≤—Å–µ—Ö trails
- –û–¥–∏–Ω vertex buffer –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
- –û–¥–∏–Ω draw call –≤–º–µ—Å—Ç–æ N
- Instance-based rendering –∏–ª–∏ geometry batching

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**:
- N draw calls ‚Üí 1 draw call
- –°–Ω–∏–∂–µ–Ω–∏–µ GPU overhead –Ω–∞ 30-50%
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 50+ –∞–≥–µ–Ω—Ç–æ–≤ –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ FPS

---

## –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### Baseline (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
–ò–∑–º–µ—Ä–∏—Ç—å –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `preset='medium'`:
- FPS –ø—Ä–∏ N=5, 10, 20, 30 –∞–≥–µ–Ω—Ç–∞—Ö
- Frame time breakdown (physics, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, UI)
- GPU query count –∑–∞ –∫–∞–¥—Ä
- Mesh update count –∑–∞ –∫–∞–¥—Ä
- CPU usage %
- Memory usage

### Target (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
- **FPS improvement**: +30-50% –ø—Ä–∏ N=20 –∞–≥–µ–Ω—Ç–∞—Ö
- **CPU load**: -40-60%
- **GPU queries**: -50-70%
- **Draw calls**: N ‚Üí 1-3 (–ø–æ—á—Ç–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: 30+ –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö 30+ FPS

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —á–∏—Å–ª–∞
| –ú–µ—Ç—Ä–∏–∫–∞ | Baseline (N=20) | Target (N=20) | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----------------|---------------|-----------|
| FPS | ~25-30 | ~40-50 | +60% |
| Frame time | ~35ms | ~20ms | -43% |
| GPU queries/frame | ~25-30 | ~5-10 | -70% |
| Draw calls/frame | ~25-30 | ~1-3 | -90% |
| CPU usage | ~60-70% | ~30-40% | -50% |

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: Baseline Measurement (1 –∑–∞–¥–∞—á–∞)
1. –°–æ–∑–¥–∞—Ç—å `PerformanceProfiler` –∫–ª–∞—Å—Å
2. –ò–∑–º–µ—Ä–∏—Ç—å –≤—Å–µ baseline –º–µ—Ç—Ä–∏–∫–∏
3. –ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ JSON –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

### Phase 2: Vectorized Height Computation (2 –∑–∞–¥–∞—á–∏)
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `_interpolate_q_from_grid_vectorized()`
2. –û–±–Ω–æ–≤–∏—Ç—å `get_q_value_for_states_batch()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å unit tests –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
4. –ò–∑–º–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Phase 3: Lazy Stats Caching (2 –∑–∞–¥–∞—á–∏)
1. –°–æ–∑–¥–∞—Ç—å `StatsCache` –∫–ª–∞—Å—Å —Å dirty flags
2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `TrainingVisualizer.update_stats_display()`
3. –î–æ–±–∞–≤–∏—Ç—å configurable update frequency
4. –ò–∑–º–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Phase 4: Batched Trail Rendering (3 –∑–∞–¥–∞—á–∏)
1. –°–æ–∑–¥–∞—Ç—å `BatchedTrailRenderer` –∫–ª–∞—Å—Å
2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `VisualAgent` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è batched renderer
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å vertex buffer updates (partial updates)
4. –ò–∑–º–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### Phase 5: Final Validation (1 –∑–∞–¥–∞—á–∞)
1. –°—Ä–∞–≤–Ω–∏—Ç—å final vs baseline –º–µ—Ç—Ä–∏–∫–∏
2. –°–æ–∑–¥–∞—Ç—å performance report
3. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `ursina/utils/performance_profiler.py` - Profiling utilities
2. `ursina/utils/stats_cache.py` - Stats caching system
3. `ursina/visuals/batched_trail_renderer.py` - Batched trail rendering
4. `ursina/llm/stage_4/performance_report.md` - Results

### –ò–∑–º–µ–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã:
1. `ursina/visuals/critic_heatmap.py` - Vectorized interpolation
2. `ursina/training/visualizer.py` - Stats caching integration
3. `ursina/config/visualization_config.py` - –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
4. `ursina/main.py` - Profiler integration

---

## –†–∏—Å–∫–∏ –∏ mitigation

### –†–∏—Å–∫ 1: –†–µ–≥—Ä–µ—Å—Å–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: Unit tests –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏, visual validation

### –†–∏—Å–∫ 2: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ß–∏—Å—Ç—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏, —Ö–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –†–∏—Å–∫ 3: –ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã —Ü–µ–ª–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞

---

## Success Criteria

‚úÖ –í—Å–µ —Ç—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
‚úÖ Unit tests –ø—Ä–æ–π–¥–µ–Ω—ã
‚úÖ Visual validation - –Ω–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
‚úÖ Performance –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã (–º–∏–Ω–∏–º—É–º +30% FPS)
‚úÖ –ö–æ–¥ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
‚úÖ Performance report —Å–æ–∑–¥–∞–Ω

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å `01_BASELINE_METRICS.md`
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å baseline –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
4. –ò–∑–º–µ—Ä—è—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ `02_LESSONS_LEARNED.md`
