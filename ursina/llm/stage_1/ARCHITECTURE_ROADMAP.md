# üó∫Ô∏è –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 17 –¥–µ–∫–∞–±—Ä—è 2025  
**–¶–µ–ª—å:** –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é TD3 vs CALF —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏

---

## üìã –ö—Ä–∞—Ç–∫–∏–π –ø–ª–∞–Ω (—á–µ–∫–±–æ–∫—Å—ã)

### –§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] 0.1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–∞–ø–∫—É `math` ‚Üí `physics` (–∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –º–æ–¥—É–ª–µ–º)
- [ ] 0.2. –£–±—Ä–∞—Ç—å —Ö–∞–∫ —Å `importlib` –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª—è
- [ ] 0.3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

### –§–∞–∑–∞ 1: –£–ø—Ä–æ—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
- [ ] 1.1. –£–±—Ä–∞—Ç—å `VisualsUpdateManager` (–ª–∏—à–Ω–∏–π —Å–ª–æ–π)
- [ ] 1.2. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å `MathUpdateManager` –≤ `SimulationEngine`
- [ ] 1.3. –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é (–º–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
- [ ] 1.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏

### –§–∞–∑–∞ 2: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] 2.1. –°–æ–∑–¥–∞—Ç—å `StateBuffer` (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ–π dict)
- [ ] 2.2. `SimulationEngine` –ø–∏—à–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –±—É—Ñ–µ—Ä
- [ ] 2.3. `RenderEngine` —á–∏—Ç–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞
- [ ] 2.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –æ–¥–Ω–æ–π —Ç–æ—á–∫–æ–π —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä

### –§–∞–∑–∞ 3: –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è Policy
- [ ] 3.1. –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `Policy`
- [ ] 3.2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `PDPolicy` (–ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä)
- [ ] 3.3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É `TD3Policy` (–ø–æ–∫–∞ —Å–ª—É—á–∞–π–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
- [ ] 3.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏

### –§–∞–∑–∞ 4: –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã
- [ ] 4.1. –°–æ–∑–¥–∞—Ç—å `VectorizedEnvironment` –¥–ª—è N –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π
- [ ] 4.2. –ó–∞–ø—É—Å—Ç–∏—Ç—å 10 —Ç–æ—á–µ–∫ —Å PD –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º
- [ ] 4.3. –ó–∞–ø—É—Å—Ç–∏—Ç—å 50 —Ç–æ—á–µ–∫ —Å PD –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º
- [ ] 4.4. –û—Ü–µ–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –§–∞–∑–∞ 5: –ü—Ä–æ—Å—Ç—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
- [ ] 5.1. –°–æ–∑–¥–∞—Ç—å `SimpleTrail` (–æ–¥–Ω–æ—Ü–≤–µ—Ç–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è)
- [ ] 5.2. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è 10 —Ç–æ—á–µ–∫
- [ ] 5.3. –î–æ–±–∞–≤–∏—Ç—å decimation (—Å–∫–≤–∞–∂–Ω–æ—Å—Ç—å)
- [ ] 5.4. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è 50 —Ç–æ—á–µ–∫
- [ ] 5.5. –î–æ–±–∞–≤–∏—Ç—å —Å–±—Ä–æ—Å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —ç–ø–∏–∑–æ–¥–∞

### –§–∞–∑–∞ 6: Dual –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (TD3 vs PD)
- [ ] 6.1. –°–æ–∑–¥–∞—Ç—å –¥–≤–µ –≥—Ä—É–ø–ø—ã —Ç–æ—á–µ–∫ (TD3 —Å–ª–µ–≤–∞, PD —Å–ø—Ä–∞–≤–∞)
- [ ] 6.2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π seed)
- [ ] 6.3. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ –≥—Ä—É–ø–ø—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- [ ] 6.4. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

### –§–∞–∑–∞ 7: CALF –ø–æ–ª–∏—Ç–∏–∫–∞ (3 —Ä–µ–∂–∏–º–∞)
- [ ] 7.1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `CALFPolicy` —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤
- [ ] 7.2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ TD3/Fallback –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —É—Å–ª–æ–≤–∏—è
- [ ] 7.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ
- [ ] 7.4. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ—Ç–∏–π —Ä–µ–∂–∏–º Relax
- [ ] 7.5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 10 —Ç–æ—á–∫–∞—Ö

### –§–∞–∑–∞ 8: –ú—É–ª—å—Ç–∏—Ü–≤–µ—Ç–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
- [ ] 8.1. –°–æ–∑–¥–∞—Ç—å `MultiColorTrail` —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Ä–µ–∂–∏–º–∞–º
- [ ] 8.2. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ
- [ ] 8.3. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 10 —Ç–æ—á–µ–∫ —Å –º—É–ª—å—Ç–∏—Ü–≤–µ—Ç–Ω—ã–º–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º–∏
- [ ] 8.4. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 50 —Ç–æ—á–µ–∫ —Å –º—É–ª—å—Ç–∏—Ü–≤–µ—Ç–Ω—ã–º–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º–∏

### –§–∞–∑–∞ 9: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TD3 –∞–≥–µ–Ω—Ç–∞
- [ ] 9.1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—É—á–µ–Ω–Ω–æ–≥–æ TD3 –∞–≥–µ–Ω—Ç–∞
- [ ] 9.2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å TD3 inference –≤ `TD3Policy`
- [ ] 9.3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ
- [ ] 9.4. Batch inference –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫
- [ ] 9.5. Dual –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: —á–∏—Å—Ç—ã–π TD3 vs CALF

### –§–∞–∑–∞ 10: –û–±—É—á–µ–Ω–∏–µ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
- [ ] 10.1. –†–µ–∂–∏–º headless (–±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
- [ ] 10.2. –†–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è (–º–µ–¥–ª–µ–Ω–Ω–æ)
- [ ] 10.3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
- [ ] 10.4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ checkpoints

### –§–∞–∑–∞ 11: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—á–∏
- [ ] 11.1. Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–≥—Ä–∞–¥—ã
- [ ] 11.2. –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–æ–≤ –≤ runtime
- [ ] 11.3. –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
- [ ] 11.4. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞ –∏ UI

### –§–∞–∑–∞ 12: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] 12.1. Thread-safe `StateBuffer` (queue)
- [ ] 12.2. –°–∏–º—É–ª—è—Ü–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- [ ] 12.3. –†–µ–Ω–¥–µ—Ä –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ (Ursina)
- [ ] 12.4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üìñ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–∑

### –§–∞–∑–∞ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

**–¶–µ–ª—å:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º

#### 0.1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–∞–ø–∫—É `math` ‚Üí `physics`
**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `ursina/math/` ‚Üí `ursina/physics/`
- –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –≤ –∫–æ–¥–µ
- –£–±—Ä–∞—Ç—å —Ö–∞–∫ —Å `importlib.util`

**–ü–æ—á–µ–º—É:**
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º –º–æ–¥—É–ª–µ–º `math` Python
- –¢—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω—ã–π workaround —á–µ—Ä–µ–∑ `importlib`
- –ò–º—è `physics` –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (—Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
cd ursina
python main.py
# –î–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
```

#### 0.2. –£–±—Ä–∞—Ç—å —Ö–∞–∫ —Å `importlib`
**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
```python
# –ë—ã–ª–æ:
import importlib.util
math_module_path = Path(__file__).parent / "math" / "__init__.py"
spec = importlib.util.spec_from_file_location("math_module", math_module_path)
# ...

# –°—Ç–∞–Ω–µ—Ç:
from physics import PointSystem, MathUpdateManager
from physics.controllers import RotorController
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω

#### 0.3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:**
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –¢–æ—á–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–æ—á–∫–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç (WASD, –∑—É–º)

---

### –§–∞–∑–∞ 1: –£–ø—Ä–æ—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

**–¶–µ–ª—å:** –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

#### 1.1. –£–±—Ä–∞—Ç—å `VisualsUpdateManager`
**–ü—Ä–æ–±–ª–µ–º–∞:**
`VisualsUpdateManager` - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –æ–±–µ—Ä—Ç–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç `update()` —É –¥—Ä—É–≥–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤. –õ–∏—à–Ω–∏–π —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏.

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
```python
# –ë—ã–ª–æ –≤ main.py:
def update():
    general_object_manager.update_all()
    visuals_update_manager.update_all()  # <- —É–±–∏—Ä–∞–µ–º —ç—Ç–æ—Ç —Å–ª–æ–π

# –°—Ç–∞–Ω–µ—Ç:
def update():
    general_object_manager.update_all()
    ui_manager.update()
    input_manager.update()
    zoom_manager.update()
    object_manager.update()
```

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `main.py` - —É–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ `VisualsUpdateManager`
- `main.py` - –≤—ã–∑—ã–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–∞–ø—Ä—è–º—É—é
- `managers/visuals_update_manager.py` - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ
- –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

#### 1.2. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å `MathUpdateManager` –≤ `SimulationEngine`
**–ü—Ä–æ–±–ª–µ–º–∞:**
–î–≤–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–µ–ª–∞—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ:
- `MathUpdateManager` - —Ö—Ä–∞–Ω–∏—Ç math –æ–±—ä–µ–∫—Ç—ã –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `step()`
- `GeneralObjectManager` - —Ç–æ–∂–µ —Ö—Ä–∞–Ω–∏—Ç math –æ–±—ä–µ–∫—Ç—ã –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `step()`

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `MathUpdateManager` ‚Üí `SimulationEngine`
2. –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `GeneralObjectManager`
3. `SimulationEngine` –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
4. `GeneralObjectManager` —Å–≤—è–∑—ã–≤–∞–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
SimulationEngine (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞):
  - PointSystem objects
  - Controllers
  - step() –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤

GeneralObjectManager (—Å–≤—è–∑—å math‚Üîvisual):
  - –°–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã –≤ SimulationEngine
  - –°–æ–∑–¥–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
  - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ `step()`

#### 1.3. –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
**–¶–µ–ª—å:** –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏

**–ë—ã–ª–æ (10 –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —Å –∂–µ—Å—Ç–∫–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏):**
```python
color_manager = ColorManager()
player = Player()
window_manager = WindowManager(color_manager, monitor="left")
zoom_manager = ZoomManager(player)
object_manager = ObjectManager(zoom_manager)
input_manager = InputManager(zoom_manager, player)
ui_manager = UIManager(color_manager, player, zoom_manager)
math_update_manager = MathUpdateManager()
general_object_manager = GeneralObjectManager(math_update_manager, object_manager, zoom_manager)
visuals_update_manager = VisualsUpdateManager(ui_manager, input_manager, zoom_manager, object_manager, general_object_manager)
```

**–°—Ç–∞–Ω–µ—Ç (–º–µ–Ω—å—à–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π):**
```python
# –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
player = Player()
color_manager = ColorManager()

# –ú–µ–Ω–µ–¥–∂–µ—Ä—ã (–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ)
window_manager = WindowManager(color_manager, monitor="left")
zoom_manager = ZoomManager(player)
input_manager = InputManager(zoom_manager, player)
object_manager = ObjectManager(zoom_manager)
ui_manager = UIManager(color_manager, player, zoom_manager)

# –°–∏–º—É–ª—è—Ü–∏—è
simulation_engine = SimulationEngine()
scene_manager = SceneManager(simulation_engine, object_manager)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–µ–Ω
- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

#### 1.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏
**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:**
- –¢–æ—á–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –¢–æ—á–∫–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è –ø–æ —Ñ–∏–∑–∏–∫–µ
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤–ª–∏—è–µ—Ç –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π

---

### –§–∞–∑–∞ 2: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∫ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π

#### 2.1. –°–æ–∑–¥–∞—Ç—å `StateBuffer`
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/core/state_buffer.py`

```python
class StateBuffer:
    """
    –ë—É—Ñ–µ—Ä –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π –æ—Ç —Å–∏–º—É–ª—è—Ü–∏–∏ –∫ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
    –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (dict), –ø–æ—Ç–æ–º —Å—Ç–∞–Ω–µ—Ç thread-safe.
    """
    def __init__(self):
        self._states = {}  # {obj_id: np.array}
    
    def write(self, obj_id: str, state: np.ndarray):
        """–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (–∏–∑ —Å–∏–º—É–ª—è—Ü–∏–∏)"""
        self._states[obj_id] = state.copy()
    
    def read(self, obj_id: str) -> np.ndarray:
        """–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ (–¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)"""
        return self._states.get(obj_id)
    
    def read_all(self) -> dict:
        """–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è"""
        return self._states.copy()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –¢–µ—Å—Ç
buffer = StateBuffer()
buffer.write('obj1', np.array([1.0, 2.0, 3.0]))
state = buffer.read('obj1')
print(state)  # [1.0, 2.0, 3.0]
```

#### 2.2. SimulationEngine –ø–∏—à–µ—Ç –≤ –±—É—Ñ–µ—Ä
**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
```python
class SimulationEngine:
    def __init__(self, state_buffer=None):
        self.objects = {}
        self.state_buffer = state_buffer  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    
    def step(self):
        for obj_id, obj in self.objects.items():
            obj.step()
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –±—É—Ñ–µ—Ä - –ø–∏—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if self.state_buffer:
                state = obj.get_state()
                self.state_buffer.write(obj_id, state)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –±—É—Ñ–µ—Ä–∞ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- –°–∏–º—É–ª—è—Ü–∏—è –ø–∏—à–µ—Ç –≤ –±—É—Ñ–µ—Ä, –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω

#### 2.3. RenderEngine —á–∏—Ç–∞–µ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞
**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
```python
class RenderEngine:
    def __init__(self, state_buffer):
        self.state_buffer = state_buffer
        self.visuals = {}
    
    def update(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏–∑ –±—É—Ñ–µ—Ä–∞"""
        states = self.state_buffer.read_all()
        for obj_id, state in states.items():
            if obj_id in self.visuals:
                self.visuals[obj_id].update_from_state(state)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —á–∏—Ç–∞–µ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞
- –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

#### 2.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä
**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç:**
```python
# –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä
buffer = StateBuffer()

# –°–∏–º—É–ª—è—Ü–∏—è –ø–∏—à–µ—Ç
sim = SimulationEngine(state_buffer=buffer)
sim.add_object('point1', PointSystem(...))

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —á–∏—Ç–∞–µ—Ç
render = RenderEngine(state_buffer=buffer)
render.add_visual('point1', PointVisual(...))

# –¶–∏–∫–ª
def update():
    sim.step()       # –û–±–Ω–æ–≤–∏–ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É ‚Üí –∑–∞–ø–∏—Å–∞–ª–∏ –≤ –±—É—Ñ–µ—Ä
    render.update()  # –ü—Ä–æ—á–∏—Ç–∞–ª–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ ‚Üí –æ–±–Ω–æ–≤–∏–ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –¢–æ—á–∫–∞ –¥–≤–∏–≥–∞–µ—Ç—Å—è
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é (—Ç–æ–ª—å–∫–æ —Å–∏–º—É–ª—è—Ü–∏—è)

---

### –§–∞–∑–∞ 3: –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è Policy

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ (TD3, PD, CALF)

#### 3.1. –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `Policy`
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/physics/policies/base_policy.py`

```python
from abc import ABC, abstractmethod
import numpy as np

class Policy(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–∏—Ç–∏–∫"""
    
    @abstractmethod
    def get_action(self, state: np.ndarray) -> np.ndarray:
        """
        –ü–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        
        Parameters:
        -----------
        state : np.ndarray
            –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        
        Returns:
        --------
        action : np.ndarray
            –î–µ–π—Å—Ç–≤–∏–µ
        """
        pass
    
    def get_actions_batch(self, states: np.ndarray) -> np.ndarray:
        """
        –ü–æ–ª—É—á–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –±–∞—Ç—á–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ü–∏–∫–ª, –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        """
        return np.array([self.get_action(s) for s in states])
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ö–ª–∞—Å—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ú–æ–∂–Ω–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è

#### 3.2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `PDPolicy`
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/physics/policies/pd_policy.py`

```python
class PDPolicy(Policy):
    """PD –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä"""
    def __init__(self, kp=1.0, kd=0.5, target=None):
        self.kp = kp
        self.kd = kd
        self.target = target if target is not None else np.zeros(2)
    
    def get_action(self, state):
        """
        state = [x, y, vx, vy, ...]
        action = Kp * error + Kd * error_dot
        """
        position = state[:2]
        velocity = state[2:4] if len(state) >= 4 else np.zeros(2)
        
        error = self.target - position
        error_dot = -velocity  # –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ target —Å—Ç–∞—Ç–∏—á–µ–Ω
        
        action = self.kp * error + self.kd * error_dot
        return action
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
policy = PDPolicy(kp=1.0, kd=0.5, target=np.array([1.0, 1.0]))
state = np.array([0.0, 0.0, 0.1, 0.1])
action = policy.get_action(state)
print(action)  # –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –∫ target
```

#### 3.3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É `TD3Policy`
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/physics/policies/td3_policy.py`

```python
class TD3Policy(Policy):
    """TD3 –∞–≥–µ–Ω—Ç (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)"""
    def __init__(self, agent=None, action_dim=2):
        self.agent = agent
        self.action_dim = action_dim
    
    def get_action(self, state):
        if self.agent is None:
            # –ó–∞–≥–ª—É—à–∫–∞: —Å–ª—É—á–∞–π–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            return np.random.randn(self.action_dim) * 0.1
        else:
            # –†–µ–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç (–§–∞–∑–∞ 9)
            with torch.no_grad():
                state_tensor = torch.FloatTensor(state).unsqueeze(0)
                action = self.agent.actor(state_tensor)
            return action.cpu().numpy().squeeze()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
policy = TD3Policy(action_dim=2)
state = np.array([0.0, 0.0])
action = policy.get_action(state)
print(action)  # —Å–ª—É—á–∞–π–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
```

#### 3.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏
**–¢–µ—Å—Ç:**
```python
# –°–æ–∑–¥–∞–µ–º –¥–≤–µ –ø–æ–ª–∏—Ç–∏–∫–∏
pd_policy = PDPolicy(kp=1.0, kd=0.5)
td3_policy = TD3Policy(action_dim=2)

# –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É —Å PD
point1 = PointSystem(policy=pd_policy)

# –ú–µ–Ω—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –≤ runtime
point1.policy = td3_policy

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
state = point1.get_state()
action = point1.policy.get_action(state)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏
- –û–±–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

---

### –§–∞–∑–∞ 4: –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã

**–¶–µ–ª—å:** –ó–∞–ø—É—Å—Ç–∏—Ç—å N –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫

#### 4.1. –°–æ–∑–¥–∞—Ç—å `VectorizedEnvironment`
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/physics/vectorized_env.py`

```python
class VectorizedEnvironment:
    """N –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–∏–º—É–ª—è—Ü–∏–π"""
    def __init__(self, n_envs, env_config, policy, seed=None):
        self.n_envs = n_envs
        self.envs = [create_environment(env_config) for _ in range(n_envs)]
        self.policy = policy
        
        # –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        self.states = None
        
        if seed is not None:
            for i, env in enumerate(self.envs):
                env.seed(seed + i)
    
    def reset(self):
        """–°–±—Ä–æ—Å –≤—Å–µ—Ö —Å—Ä–µ–¥"""
        self.states = np.array([env.reset() for env in self.envs])
        return self.states
    
    def step(self):
        """Batch —à–∞–≥ –≤—Å–µ—Ö —Å—Ä–µ–¥"""
        # –ü–æ–ª—É—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ (batch)
        actions = self.policy.get_actions_batch(self.states)
        
        # –®–∞–≥ –∫–∞–∂–¥–æ–π —Å—Ä–µ–¥—ã
        next_states = []
        rewards = []
        dones = []
        
        for i, env in enumerate(self.envs):
            s, r, d = env.step(actions[i])
            next_states.append(s)
            rewards.append(r)
            dones.append(d)
        
        self.states = np.array(next_states)
        return self.states, np.array(rewards), np.array(dones)
    
    def get_states(self):
        """–í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏"""
        return self.states.copy()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
policy = PDPolicy(kp=1.0, kd=0.5)
vec_env = VectorizedEnvironment(n_envs=10, env_config={}, policy=policy)
states = vec_env.reset()
print(states.shape)  # (10, state_dim)

for _ in range(100):
    states, rewards, dones = vec_env.step()
```

#### 4.2. –ó–∞–ø—É—Å—Ç–∏—Ç—å 10 —Ç–æ—á–µ–∫ —Å PD
**–¢–µ—Å—Ç –≤ main.py:**
```python
pd_policy = PDPolicy(kp=1.0, kd=0.5, target=np.array([1.0, 1.0]))
vec_env = VectorizedEnvironment(n_envs=10, env_config={}, policy=pd_policy)
vec_env.reset()

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è 10 —Ç–æ—á–µ–∫
points = [PointVisual(color=color.red) for _ in range(10)]

def update():
    states, _, _ = vec_env.step()
    for i, state in enumerate(states):
        points[i].position = Vec3(state[0], 0, state[1])
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- 10 —Ç–æ—á–µ–∫ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- –í—Å–µ –¥–≤–∏–≥–∞—é—Ç—Å—è –∫ target
- FPS –ø—Ä–∏–µ–º–ª–µ–º—ã–π

#### 4.3. –ó–∞–ø—É—Å—Ç–∏—Ç—å 50 —Ç–æ—á–µ–∫
**–¢–µ—Å—Ç:**
- –¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ `n_envs=50`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- 50 —Ç–æ—á–µ–∫ —Ä–∞–±–æ—Ç–∞—é—Ç
- FPS > 30

#### 4.4. –û—Ü–µ–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
**–ú–µ—Ç—Ä–∏–∫–∏:**
- FPS –¥–ª—è 10, 50, 100 —Ç–æ—á–µ–∫
- –í—Ä–µ–º—è –Ω–∞ —à–∞–≥ —Å–∏–º—É–ª—è—Ü–∏–∏
- –í—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:**
- –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ñ–∏–∑–∏–∫–∏ (NumPy –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞)
- Batch —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

---

### –§–∞–∑–∞ 5: –ü—Ä–æ—Å—Ç—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π (—Ö–≤–æ—Å—Ç–æ–≤)

#### 5.1. –°–æ–∑–¥–∞—Ç—å `SimpleTrail`
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/visuals/trail.py`

```python
class SimpleTrail:
    """–ü—Ä–æ—Å—Ç–∞—è –æ–¥–Ω–æ—Ü–≤–µ—Ç–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è"""
    def __init__(self, color, max_length=200, decimation=1):
        self.color = color
        self.max_length = max_length
        self.decimation = decimation
        self.positions = []
        self.trail_entity = None
        self.step_counter = 0
    
    def add_point(self, position):
        """–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –≤ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é"""
        self.step_counter += 1
        if self.step_counter % self.decimation != 0:
            return
        
        self.positions.append(Vec3(*position))
        if len(self.positions) > self.max_length:
            self.positions.pop(0)
        
        self.rebuild()
    
    def rebuild(self):
        """–ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é"""
        if self.trail_entity:
            destroy(self.trail_entity)
        
        if len(self.positions) >= 2:
            self.trail_entity = Entity(
                model=Mesh(vertices=self.positions, mode='line', thickness=2),
                color=self.color,
                alpha=0.7
            )
    
    def clear(self):
        """–û—á–∏—Å—Ç–∏—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é"""
        self.positions = []
        self.step_counter = 0
        if self.trail_entity:
            destroy(self.trail_entity)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
trail = SimpleTrail(color=color.red, max_length=100)
for i in range(200):
    trail.add_point([i*0.01, np.sin(i*0.1), 0])
# –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–∏–Ω—É—Å–æ–∏–¥–∞
```

#### 5.2. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 10 —Ç–æ—á–µ–∫ —Å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º–∏
**–¢–µ—Å—Ç:**
```python
n_points = 10
vec_env = VectorizedEnvironment(n_envs=n_points, ...)
trails = [SimpleTrail(color=color.red) for _ in range(n_points)]

def update():
    states, _, dones = vec_env.step()
    for i, state in enumerate(states):
        position = [state[0], 0, state[1]]
        trails[i].add_point(position)
        
        # –°–±—Ä–æ—Å –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —ç–ø–∏–∑–æ–¥–∞
        if dones[i]:
            vec_env.envs[i].reset()
            trails[i].clear()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- 10 —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ—á–∏—â–∞—é—Ç—Å—è –ø—Ä–∏ —Å–±—Ä–æ—Å–µ

#### 5.3. –î–æ–±–∞–≤–∏—Ç—å decimation
**–¢–µ—Å—Ç:**
```python
# decimation=1: –∫–∞–∂–¥–∞—è —Ç–æ—á–∫–∞
# decimation=2: –∫–∞–∂–¥–∞—è –≤—Ç–æ—Ä–∞—è
# decimation=5: –∫–∞–∂–¥–∞—è –ø—è—Ç–∞—è

trail = SimpleTrail(color=color.red, decimation=2)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –≤ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏
- –í—ã—à–µ FPS
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –≤—Å–µ –µ—â–µ —á–∏—Ç–∞–µ–º–∞—è

#### 5.4. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 50 —Ç–æ—á–µ–∫
**–¢–µ—Å—Ç:**
- `n_points=50`
- `decimation=2` –∏–ª–∏ `decimation=3`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- 50 —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç
- FPS –ø—Ä–∏–µ–º–ª–µ–º—ã–π

#### 5.5. –°–±—Ä–æ—Å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —ç–ø–∏–∑–æ–¥–∞
**–õ–æ–≥–∏–∫–∞:**
```python
if done[i]:
    env.envs[i].reset()
    trails[i].clear()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ—á–∏—â–∞—é—Ç—Å—è
- –ù–æ–≤—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –Ω–∞—á–∞–ª–∞

---

### –§–∞–∑–∞ 6: Dual –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (TD3 vs PD)

**–¶–µ–ª—å:** –°—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ

#### 6.1. –°–æ–∑–¥–∞—Ç—å –¥–≤–µ –≥—Ä—É–ø–ø—ã —Ç–æ—á–µ–∫
**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
# –ì—Ä—É–ø–ø–∞ 1: TD3 (—Å–ª–µ–≤–∞)
vec_env_td3 = VectorizedEnvironment(n_envs=50, policy=td3_policy, seed=42)
trails_td3 = [SimpleTrail(color=color.red) for _ in range(50)]

# –ì—Ä—É–ø–ø–∞ 2: PD (—Å–ø—Ä–∞–≤–∞, —Å–¥–≤–∏–≥ –ø–æ Z)
vec_env_pd = VectorizedEnvironment(n_envs=50, policy=pd_policy, seed=42)
trails_pd = [SimpleTrail(color=color.green) for _ in range(50)]

def update():
    # TD3
    states_td3, _, dones_td3 = vec_env_td3.step()
    for i, state in enumerate(states_td3):
        pos = [state[0], 0, state[1]]
        trails_td3[i].add_point(pos)
    
    # PD (—Å–¥–≤–∏–≥ –ø–æ Z)
    states_pd, _, dones_pd = vec_env_pd.step()
    for i, state in enumerate(states_pd):
        pos = [state[0], 0, state[1] + 5]  # —Å–¥–≤–∏–≥!
        trails_pd[i].add_point(pos)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –î–≤–µ –≥—Ä—É–ø–ø—ã –ø–æ 50 —Ç–æ—á–µ–∫
- –°–ª–µ–≤–∞ - –∫—Ä–∞—Å–Ω—ã–µ (TD3)
- –°–ø—Ä–∞–≤–∞ - –∑–µ–ª–µ–Ω—ã–µ (PD)

#### 6.2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
**–í–∞–∂–Ω–æ:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–π seed –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

```python
vec_env_td3 = VectorizedEnvironment(..., seed=42)
vec_env_pd = VectorizedEnvironment(..., seed=42)

# –ü—Ä–æ–≤–µ—Ä–∫–∞:
assert np.allclose(vec_env_td3.states, vec_env_pd.states)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –û–±–µ –≥—Ä—É–ø–ø—ã –Ω–∞—á–∏–Ω–∞—é—Ç —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- –†–∞–∑–ª–∏—á–∏—è —Ç–æ–ª—å–∫–æ –∏–∑-–∑–∞ –ø–æ–ª–∏—Ç–∏–∫

#### 6.3. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ –≥—Ä—É–ø–ø—ã
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–∏–¥–Ω—ã —Ä–∞–∑–ª–∏—á–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏
- PD —Å—Ç–∞–±–∏–ª—å–Ω—ã–π (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
- TD3 –ø–æ–∫–∞ —Å–ª—É—á–∞–π–Ω—ã–π (–∑–∞–≥–ª—É—à–∫–∞)

#### 6.4. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
**UI —ç–ª–µ–º–µ–Ω—Ç:**
```python
stats_text = Text(
    text='',
    position=(-0.85, 0.45),
    scale=1.2
)

def update_stats():
    n_success_td3 = sum(rewards_td3 > 0)
    n_success_pd = sum(rewards_pd > 0)
    
    stats_text.text = f'''TD3: {n_success_td3}/50 success
PD:  {n_success_pd}/50 success'''
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- –¶–∏—Ñ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

---

### –§–∞–∑–∞ 7: CALF –ø–æ–ª–∏—Ç–∏–∫–∞ (3 —Ä–µ–∂–∏–º–∞)

**–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CALF —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º TD3/Relax/Fallback

#### 7.1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `CALFPolicy` —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏
**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `ursina/physics/policies/calf_policy.py`

```python
class CALFPolicy(Policy):
    """CALF: TD3 —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–∞ Relax/Fallback"""
    def __init__(self, td3_policy, pd_policy, 
                 fallback_threshold=0.3, relax_threshold=0.6):
        self.td3 = td3_policy
        self.pd = pd_policy
        self.fallback_threshold = fallback_threshold
        self.relax_threshold = relax_threshold
        
        self.current_mode = 'td3'  # –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    
    def get_action(self, state):
        # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è safety metric (–ø–æ–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–µ)
        safety_metric = np.random.rand()
        
        if safety_metric < self.fallback_threshold:
            self.current_mode = 'fallback'
            return self.pd.get_action(state)
        elif safety_metric < self.relax_threshold:
            self.current_mode = 'relax'
            # –°–º–µ—Å—å TD3 –∏ PD
            alpha = (safety_metric - self.fallback_threshold) / \
                    (self.relax_threshold - self.fallback_threshold)
            return alpha * self.td3.get_action(state) + \
                   (1 - alpha) * self.pd.get_action(state)
        else:
            self.current_mode = 'td3'
            return self.td3.get_action(state)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
calf = CALFPolicy(td3_policy, pd_policy)
action = calf.get_action(state)
print(calf.current_mode)  # 'td3', 'relax', –∏–ª–∏ 'fallback'
```

#### 7.2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —É—Å–ª–æ–≤–∏—è
**–ü—Ä–∏–º–µ—Ä:** –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–ª–∏

```python
def get_safety_metric(self, state):
    """–ü—Ä–æ—Å—Ç–∞—è –º–µ—Ç—Ä–∏–∫–∞: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç target"""
    position = state[:2]
    distance = np.linalg.norm(position - self.target)
    
    # –ß–µ–º –¥–∞–ª—å—à–µ, —Ç–µ–º –æ–ø–∞—Å–Ω–µ–µ (–º–µ–Ω—å—à–µ safety)
    safety = 1.0 / (1.0 + distance)
    return safety
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–±–ª–∏–∑–∏ target: safety –≤—ã—Å–æ–∫–∏–π ‚Üí TD3
- –î–∞–ª–µ–∫–æ –æ—Ç target: safety –Ω–∏–∑–∫–∏–π ‚Üí Fallback

#### 7.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ
**–¢–µ—Å—Ç:**
```python
calf = CALFPolicy(td3_policy, pd_policy, target=np.array([1, 1]))
point = PointSystem(policy=calf)

for step in range(100):
    point.step()
    print(f"Step {step}: mode={calf.current_mode}, pos={point.get_state()[:2]}")
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –†–µ–∂–∏–º—ã –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è
- –ü—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ target: fallback ‚Üí relax ‚Üí td3

#### 7.4. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ—Ç–∏–π —Ä–µ–∂–∏–º Relax
**–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ 7.1** - —Å–º–µ—Å—å TD3 –∏ PD

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
- –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ (—á–µ—Ä–µ–∑ Relax)

#### 7.5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 10 —Ç–æ—á–∫–∞—Ö
**–¢–µ—Å—Ç:**
```python
calf_policy = CALFPolicy(td3_policy, pd_policy)
vec_env = VectorizedEnvironment(n_envs=10, policy=calf_policy)

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ü–≤–µ—Ç–æ–≤—ã–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
def update():
    states, _, _ = vec_env.step()
    for i, state in enumerate(states):
        mode = calf_policy.get_mode_for_env(i)  # –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å batch
        color = MODE_COLORS[mode]
        points[i].color = color
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- 10 —Ç–æ—á–µ–∫ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏
- –¶–≤–µ—Ç–∞ –º–µ–Ω—è—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞

---

### –§–∞–∑–∞ 8: –ú—É–ª—å—Ç–∏—Ü–≤–µ—Ç–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏

**–¶–µ–ª—å:** –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è CALF –≤ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è—Ö

#### 8.1. –°–æ–∑–¥–∞—Ç—å `MultiColorTrail`
**–§–∞–π–ª:** `ursina/visuals/multi_color_trail.py`

```python
class MultiColorTrail:
    """–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ —Ä–∞–∑–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞"""
    
    MODE_COLORS = {
        'td3': color.blue,
        'relax': color.green,
        'fallback': color.orange
    }
    
    def __init__(self, max_length=200, decimation=1):
        self.max_length = max_length
        self.decimation = decimation
        self.positions = []
        self.modes = []
        self.segments = []
        self.step_counter = 0
    
    def add_point(self, position, mode):
        """–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É —Å —Ä–µ–∂–∏–º–æ–º"""
        self.step_counter += 1
        if self.step_counter % self.decimation != 0:
            return
        
        self.positions.append(Vec3(*position))
        self.modes.append(mode)
        
        if len(self.positions) > self.max_length:
            self.positions.pop(0)
            self.modes.pop(0)
        
        self.rebuild_trail()
    
    def rebuild_trail(self):
        """–ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Ä–µ–∂–∏–º–∞–º"""
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã
        for seg in self.segments:
            destroy(seg)
        self.segments = []
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ä–µ–∂–∏–º–∞–º
        groups = self._group_by_mode()
        
        # –†–∏—Å—É–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
        for mode, points in groups:
            if len(points) >= 2:
                seg = Entity(
                    model=Mesh(vertices=points, mode='line', thickness=3),
                    color=self.MODE_COLORS[mode],
                    alpha=0.7
                )
                self.segments.append(seg)
    
    def _group_by_mode(self):
        """–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –ø–æ —Ä–µ–∂–∏–º—É"""
        # (—Å–º. –ø–æ–¥—Ä–æ–±–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤—ã—à–µ –≤ –∫–æ–¥–µ)
        pass
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
trail = MultiColorTrail()
trail.add_point([0, 0, 0], 'td3')
trail.add_point([0.1, 0, 0], 'td3')
trail.add_point([0.2, 0, 0], 'fallback')
trail.add_point([0.3, 0, 0], 'fallback')
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∏–Ω–∏–π –∏ –æ—Ä–∞–Ω–∂–µ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç—ã
```

#### 8.2. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ
**–¢–µ—Å—Ç:**
```python
calf = CALFPolicy(td3, pd)
trail = MultiColorTrail()

def update():
    state = env.get_state()
    action = calf.get_action(state)
    env.step(action)
    
    position = [state[0], 0, state[1]]
    trail.add_point(position, calf.current_mode)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è—Ö
- –°–∏–Ω–∏–π (TD3) ‚Üí –ó–µ–ª–µ–Ω—ã–π (Relax) ‚Üí –û—Ä–∞–Ω–∂–µ–≤—ã–π (Fallback)

#### 8.3. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 10 —Ç–æ—á–µ–∫
**–¢–µ—Å—Ç:**
- 10 —Ç–æ—á–µ–∫ —Å `MultiColorTrail`
- –ö–∞–∂–¥–∞—è —Å–æ —Å–≤–æ–∏–º–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–∏–¥–Ω—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–µ–º–ª–µ–º–∞—è

#### 8.4. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 50 —Ç–æ—á–µ–∫
**–¢–µ—Å—Ç:**
- 50 —Ç–æ—á–µ–∫ —Å –º—É–ª—å—Ç–∏—Ü–≤–µ—Ç–Ω—ã–º–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è–º–∏
- Decimation=2 –∏–ª–∏ 3

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- FPS > 30
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ —á–∏—Ç–∞–µ–º—ã–µ
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–Ω—ã

---

### –§–∞–∑–∞ 9: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TD3 –∞–≥–µ–Ω—Ç–∞

**–¶–µ–ª—å:** –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–Ω–æ–≥–æ TD3 –∞–≥–µ–Ω—Ç–∞

#### 9.1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—É—á–µ–Ω–Ω–æ–≥–æ TD3
**–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è:**
- –ï—Å—Ç—å —Ñ–∞–π–ª `calf_model.pth` –∏–ª–∏ `td3_agent.pth`
- –ï—Å—Ç—å –∫–ª–∞—Å—Å TD3 –∞–≥–µ–Ω—Ç–∞

**–ö–æ–¥:**
```python
from RL.td3 import TD3Agent

# –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≥–µ–Ω—Ç–∞
agent = TD3Agent(state_dim=..., action_dim=..., max_action=...)
agent.load('RL/calf_model.pth')
agent.actor.eval()  # evaluation mode
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
state = np.array([0, 0, 0, 0])
action = agent.select_action(state)
print(action)  # –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
```

#### 9.2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ `TD3Policy`
**–û–±–Ω–æ–≤–∏—Ç—å:** `ursina/physics/policies/td3_policy.py`

```python
class TD3Policy(Policy):
    def __init__(self, agent):
        self.agent = agent
    
    def get_action(self, state):
        with torch.no_grad():
            state_tensor = torch.FloatTensor(state).unsqueeze(0)
            action = self.agent.actor(state_tensor)
        return action.cpu().numpy().squeeze()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ê–≥–µ–Ω—Ç –≤—ã–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è
- –ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

#### 9.3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ
**–¢–µ—Å—Ç:**
```python
td3_policy = TD3Policy(agent)
env = Environment()
state = env.reset()

for _ in range(100):
    action = td3_policy.get_action(state)
    state, reward, done = env.step(action)
    if done:
        break

print(f"Reward: {reward}")
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ê–≥–µ–Ω—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–æ–π
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ (–Ω–µ —Å–ª—É—á–∞–π–Ω–æ–µ)

#### 9.4. Batch inference –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫
**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
```python
def get_actions_batch(self, states):
    """Batch inference - –±—ã—Å—Ç—Ä–µ–µ —á–µ–º —Ü–∏–∫–ª"""
    with torch.no_grad():
        states_tensor = torch.FloatTensor(states)  # (N, state_dim)
        actions = self.agent.actor(states_tensor)  # (N, action_dim)
    return actions.cpu().numpy()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
states = np.random.randn(50, state_dim)
actions = td3_policy.get_actions_batch(states)
print(actions.shape)  # (50, action_dim)
```

#### 9.5. Dual –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: —á–∏—Å—Ç—ã–π TD3 vs CALF
**–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –§–∞–∑—ã 9:**
```python
# –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≥–µ–Ω—Ç–∞
agent = TD3Agent(...)
agent.load('RL/calf_model.pth')

# –ü–æ–ª–∏—Ç–∏–∫–∏
td3_policy = TD3Policy(agent)
pd_policy = PDPolicy(kp=1.0, kd=0.5)
calf_policy = CALFPolicy(td3_policy, pd_policy)

# Dual –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
vis = DualVisualization(
    n_points=50,
    policy_1=td3_policy,
    policy_2=calf_policy,
    seed=42
)

def update():
    vis.step()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–∏–¥–Ω—ã —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —á–∏—Å—Ç—ã–º TD3 –∏ CALF
- CALF –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ fallback –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è

---

### –§–∞–∑–∞ 10: –û–±—É—á–µ–Ω–∏–µ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π

**–¶–µ–ª—å:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è TD3 —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π

#### 10.1. –†–µ–∂–∏–º headless
**–§–ª–∞–≥ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
class SimulationConfig:
    def __init__(self, render_mode=None):
        self.render_mode = render_mode  # None, 'human', 'rgb_array'

# –ë—ã—Å—Ç—Ä–æ–µ –æ–±—É—á–µ–Ω–∏–µ
sim = Simulation(render_mode=None)  # –±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

# –° –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
sim = Simulation(render_mode='human')
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Headless mode –±—ã—Å—Ç—Ä–µ–µ –≤ 10+ —Ä–∞–∑
- –û–±—É—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

#### 10.2. –†–µ–∂–∏–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è
**–û–ø—Ü–∏—è:**
```python
# –û–±—É—á–µ–Ω–∏–µ —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫–∞–∂–¥—ã–µ N —ç–ø–∏–∑–æ–¥–æ–≤
for episode in range(max_episodes):
    # –û–±—É—á–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–Ω–¥–µ—Ä–∞ (–±—ã—Å—Ç—Ä–æ)
    if episode % render_every != 0:
        sim.render_mode = None
    else:
        sim.render_mode = 'human'
    
    # –≠–ø–∏–∑–æ–¥
    run_episode(sim, agent)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
- –ù–µ —Å–∏–ª—å–Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–±—É—á–µ–Ω–∏–µ

#### 10.3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
**–ú–µ—Ç—Ä–∏–∫–∏:**
- –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ —ç–ø–∏–∑–æ–¥
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –Ω–∞ fallback
- –°—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å (% –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏)

**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
import matplotlib.pyplot as plt

metrics = {
    'td3_rewards': [],
    'calf_rewards': [],
    'fallback_activations': []
}

# –ü–æ—Å–ª–µ —ç–ø–∏–∑–æ–¥–∞
metrics['td3_rewards'].append(total_reward_td3)
metrics['calf_rewards'].append(total_reward_calf)

# –ì—Ä–∞—Ñ–∏–∫
plt.plot(metrics['td3_rewards'], label='TD3')
plt.plot(metrics['calf_rewards'], label='CALF')
plt.legend()
plt.savefig('training_comparison.png')
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–µ—Ç—Ä–∏–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å
- CALF –Ω–µ —Ö—É–∂–µ TD3 (–∞ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ!)

#### 10.4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ checkpoints
**–ö–æ–¥:**
```python
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
if episode % save_every == 0:
    agent.save(f'checkpoints/agent_episode_{episode}.pth')
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    np.savez(f'checkpoints/metrics_episode_{episode}.npz', **metrics)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Checkpoints —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
- –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

---

### –§–∞–∑–∞ 11: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ–∏—á–∏

**–¶–µ–ª—å:** –£–ª—É—á—à–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

#### 11.1. Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –¥–ª—è –Ω–∞–≥—Ä–∞–¥—ã
**–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è:**
```python
def state_to_position(self, state, reward=None):
    """3D –ø–æ–∑–∏—Ü–∏—è —Å Y = –Ω–∞–≥—Ä–∞–¥–∞"""
    x, z = state[0], state[1]
    
    if self.use_reward_height and reward is not None:
        y = reward * self.reward_scale
    else:
        y = 0.0
    
    return [x, y, z]
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –∏–¥—É—Ç –≤–≤–µ—Ä—Ö –ø—Ä–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä–∞–¥–µ
- –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –∏–¥—É—Ç –≤–Ω–∏–∑ –ø—Ä–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π –Ω–∞–≥—Ä–∞–¥–µ
- –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ, –≥–¥–µ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã

#### 11.2. –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–æ–≤ –≤ runtime
**–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
def input(key):
    if key == 'up arrow':
        calf_policy.fallback_threshold += 0.05
        print(f"Fallback threshold: {calf_policy.fallback_threshold:.2f}")
    
    if key == 'down arrow':
        calf_policy.fallback_threshold -= 0.05
    
    if key == 'right arrow':
        calf_policy.relax_threshold += 0.05
    
    if key == 'left arrow':
        calf_policy.relax_threshold -= 0.05
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ü–æ—Ä–æ–≥–∏ –º–µ–Ω—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –í–∏–¥–Ω–æ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- –ú–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ

#### 11.3. –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from ursina import Recorder

recorder = Recorder()

def input(key):
    if key == 'v':
        recorder.start_recording()
        print("Recording started...")
    
    if key == 'b':
        recorder.stop_recording()
        recorder.save('trajectory_video.mp4')
        print("Video saved!")
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í–∏–¥–µ–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
- –ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏–µ–º–ª–µ–º–æ–µ
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π

#### 11.4. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞ –∏ UI
**–§–∏—á–∏:**
- –°–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
- –ó—É–º –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–æ—á–∫–∞–º
- Toggle —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- –ü–∞—É–∑–∞/–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–∏–º—É–ª—è—Ü–∏–∏

**–ö–æ–¥:**
```python
class CameraController:
    def __init__(self):
        self.paused = False
        self.follow_mode = None  # None –∏–ª–∏ –∏–Ω–¥–µ–∫—Å —Ç–æ—á–∫–∏
    
    def handle_input(self, key):
        if key == 'space':
            self.paused = not self.paused
        
        if key == 'f':
            # Follow random point
            self.follow_mode = np.random.randint(0, n_points)
        
        if key == 'escape':
            self.follow_mode = None
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ö–∞–º–µ—Ä–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–¥–æ–±–Ω–æ
- –ú–æ–∂–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏
- –ú–æ–∂–Ω–æ –ø–∞—É–∑–∏—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

---

### –§–∞–∑–∞ 12: –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–¶–µ–ª—å:** –†–∞–∑–¥–µ–ª–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é –∏ —Ä–µ–Ω–¥–µ—Ä –ø–æ —Ä–∞–∑–Ω—ã–º –ø–æ—Ç–æ–∫–∞–º

**–í–Ω–∏–º–∞–Ω–∏–µ:** Ursina —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ! –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å Entity –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ç–æ–∫–µ.

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
- –°–∏–º—É–ª—è—Ü–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ (–ø–∏—à–µ—Ç –≤ –±—É—Ñ–µ—Ä)
- –†–µ–Ω–¥–µ—Ä –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ (—á–∏—Ç–∞–µ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞)

#### 12.1. Thread-safe `StateBuffer`
**–û–±–Ω–æ–≤–∏—Ç—å:** `ursina/core/state_buffer.py`

```python
import threading
from queue import Queue

class ThreadSafeStateBuffer:
    """Thread-safe –±—É—Ñ–µ—Ä –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏"""
    def __init__(self):
        self._lock = threading.Lock()
        self._states = {}
    
    def write(self, obj_id, state):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –ø–æ—Ç–æ–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏"""
        with self._lock:
            self._states[obj_id] = state.copy()
    
    def read_all(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (—Ä–µ–Ω–¥–µ—Ä)"""
        with self._lock:
            return self._states.copy()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –¢–µ—Å—Ç –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
buffer = ThreadSafeStateBuffer()

def writer_thread():
    for i in range(1000):
        buffer.write('obj1', np.array([i, i*2]))

def reader_thread():
    for i in range(1000):
        states = buffer.read_all()
        time.sleep(0.001)

# –ó–∞–ø—É—Å–∫
t1 = threading.Thread(target=writer_thread)
t2 = threading.Thread(target=reader_thread)
t1.start()
t2.start()
t1.join()
t2.join()
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å race conditions
```

#### 12.2. –°–∏–º—É–ª—è—Ü–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
**–ö–æ–¥:**
```python
class SimulationThread:
    def __init__(self, simulation, state_buffer):
        self.simulation = simulation
        self.state_buffer = state_buffer
        self.running = False
        self.thread = None
    
    def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫ —Å–∏–º—É–ª—è—Ü–∏–∏"""
        self.running = True
        self.thread = threading.Thread(target=self._run)
        self.thread.daemon = True
        self.thread.start()
    
    def _run(self):
        """–¶–∏–∫–ª —Å–∏–º—É–ª—è—Ü–∏–∏ (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ)"""
        while self.running:
            # –®–∞–≥ —Å–∏–º—É–ª—è—Ü–∏–∏
            self.simulation.step()
            
            # –ó–∞–ø–∏—Å—å —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –±—É—Ñ–µ—Ä
            states = self.simulation.get_states()
            for obj_id, state in states.items():
                self.state_buffer.write(obj_id, state)
            
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ FPS
            # time.sleep(1/simulation_fps)
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫"""
        self.running = False
        if self.thread:
            self.thread.join()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
buffer = ThreadSafeStateBuffer()
sim_thread = SimulationThread(simulation, buffer)
sim_thread.start()

# –ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ - —Ä–µ–Ω–¥–µ—Ä
def update():
    states = buffer.read_all()
    render_engine.update(states)

# –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ
sim_thread.stop()
```

#### 12.3. –†–µ–Ω–¥–µ—Ä –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
**–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** - `update()` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ Ursina

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –°–∏–º—É–ª—è—Ü–∏—è –±–µ–∂–∏—Ç –±—ã—Å—Ç—Ä–æ (–≤ —Å–≤–æ–µ–º –ø–æ—Ç–æ–∫–µ)
- –†–µ–Ω–¥–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å 60 FPS (–ø—Ä–æ–ø—É—Å–∫–∞—è –∫–∞–¥—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏)
- –ù–µ—Ç race conditions

#### 12.4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
**–ú–µ—Ç—Ä–∏–∫–∏:**
- Simulation FPS (–±–µ–∑ —Ä–µ–Ω–¥–µ—Ä–∞): –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >> 60
- Render FPS: 60
- Latency: –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∏–º—É–ª—è—Ü–∏–µ–π –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

**–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:**
```
–û–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã–π:
  Simulation: 60 FPS (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ —Ä–µ–Ω–¥–µ—Ä–æ–º)
  Render: 60 FPS
  Total: 60 FPS

–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π:
  Simulation: 500+ FPS (–±–µ–∑ —Ä–µ–Ω–¥–µ—Ä–∞)
  Render: 60 FPS
  Total: —Å–∏–º—É–ª—è—Ü–∏—è –±—ã—Å—Ç—Ä–µ–µ –≤ 8+ —Ä–∞–∑!
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –¥–∞–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–∏–µ
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç –æ–±—É—á–µ–Ω–∏–µ
- –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å headless –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–∑:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Main Application                  ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Simulation      ‚îÇ  State  ‚îÇ Render Engine    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Thread          ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ (Main Thread)    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ (CPU)           ‚îÇ Buffer  ‚îÇ (Ursina)         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ         ‚îÇ                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - Physics       ‚îÇ         ‚îÇ - Visuals        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - TD3 Agent     ‚îÇ         ‚îÇ - Trails         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - CALF Logic    ‚îÇ         ‚îÇ - UI             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - 100+ envs     ‚îÇ         ‚îÇ - Camera         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  Policies:                   Components:           ‚îÇ
‚îÇ  - TD3Policy                 - StateBuffer         ‚îÇ
‚îÇ  - PDPolicy                  - VectorizedEnv       ‚îÇ
‚îÇ  - CALFPolicy                - MultiColorTrail     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
1. ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
2. ‚úÖ Policy –∫–∞–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å/—Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å)
3. ‚úÖ StateBuffer –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
4. ‚úÖ –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
5. ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–ö–∞–∂–¥—É—é —Ñ–∞–∑—É —Ç–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ** - –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ, –ø–æ–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- **–ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –§–∞–∑—É 12** (–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å) - –æ–Ω–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è
- **–°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–¥** - –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è
- **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–∂–Ω–∞** - –æ–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ CALF

---

## üöÄ –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å?

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –§–∞–∑–∞ 0.1 - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `math` ‚Üí `physics`

```bash
cd ursina
mv math physics
# –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ —Ñ–∞–π–ª–∞—Ö
```

–£–¥–∞—á–∏! üéØ
