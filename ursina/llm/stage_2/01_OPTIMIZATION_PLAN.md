# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ CALF - Stage 2

**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞**: 2026-01-21
**–í–∞—Ä–∏–∞–Ω—Ç –ø–ª–∞–Ω–∞**: C (—Å–º–µ—à–∞–Ω–Ω—ã–π - –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

---

## üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: 5/6 —Å—Ç–∞–¥–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ

---

# –°–µ–∫—Ü–∏—è 1: –ö—Ä–∞—Ç–∫–∏–π —á–µ–∫–ª–∏—Å—Ç —Å—Ç–∞–¥–∏–π

## –°—Ç–∞–¥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- [x] **STAGE 1**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è select_action_batch –≤ CALFController ‚úÖ
- [x] **STAGE 2**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ + Config —Å–∏—Å—Ç–µ–º–∞ ‚úÖ
- [x] **STAGE 3**: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ main.py —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚úÖ
- [x] **STAGE 4**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚úÖ
- [x] **STAGE 5**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (trails, heatmap) ‚úÖ
- [ ] **STAGE 6**: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

# –°–µ–∫—Ü–∏—è 2: –î–µ—Ç–∞–ª—å–Ω–æ–µ –¢–ó –ø–æ —Å—Ç–∞–¥–∏—è–º

---

## üéØ STAGE 1: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è select_action_batch –≤ CALFController ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ COMPLETED (Already implemented!)
**–§–∞–π–ª—ã**: `RL/calf.py` (lines 238-337)
**–í—Ä–µ–º—è**: N/A (found already implemented)

### –ü—Ä–æ–±–ª–µ–º–∞
`train_calf_visual.py:402` –≤—ã–∑—ã–≤–∞–µ—Ç `calf_agent.select_action_batch()`, –Ω–æ –º–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
–†–µ–∑—É–ª—å—Ç–∞—Ç: AttributeError –Ω–∞ —à–∞–≥–µ 1000 + –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ 32-65x –µ—Å–ª–∏ –µ—Å—Ç—å workaround —á–µ—Ä–µ–∑ —Ü–∏–∫–ª.

### –ó–∞–¥–∞—á–∏ ‚úÖ

#### 1.1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ select_action_batch ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ —Å —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π: `select_action_batch(states, exploration_noise=0.0, return_modes=False)`
- [x] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `actions` –∏–ª–∏ `(actions, modes)` –µ—Å–ª–∏ return_modes=True
- [x] Modes: ['td3', 'relax', 'fallback'] –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π
- [x] **BONUS**: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `update_state` –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è training/visualization –∞–≥–µ–Ω—Ç–æ–≤

#### 1.2. Batch actor inference ‚úÖ
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `self.td3.select_action_batch(states, noise=exploration_noise)` (line 270)
- [x] 1 GPU –≤—ã–∑–æ–≤ –≤–º–µ—Å—Ç–æ N –≤—ã–∑–æ–≤–æ–≤

#### 1.3. Batch critic inference ‚úÖ
- [x] Batch forward pass —á–µ—Ä–µ–∑ critic –¥–ª—è –≤—Å–µ—Ö (state, action) –ø–∞—Ä (lines 273-278)
- [x] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å Q-–∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] 1 GPU –≤—ã–∑–æ–≤ –≤–º–µ—Å—Ç–æ N –≤—ã–∑–æ–≤–æ–≤

#### 1.4. –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ ‚úÖ
- [x] Lyapunov decrease check: `(q_values - self.q_cert) >= self.nu_bar` (line 285, –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ)
- [x] K_infinity bounds check: `k_low <= -q_values <= k_up` (line 292, –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ)
- [x] –í—ã—á–∏—Å–ª–∏—Ç—å `state_norms = np.linalg.norm(states, axis=1)` –æ–¥–∏–Ω —Ä–∞–∑ (line 288)

#### 1.5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Q-–∑–Ω–∞—á–µ–Ω–∏–π ‚úÖ
- [x] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `update_certificate()` –¥–ª—è –ø—Ä–∏—ë–º–∞ `q_value=None` (line 156)
- [x] –ï—Å–ª–∏ q_value –ø–µ—Ä–µ–¥–∞–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ (–Ω–µ –≤—ã—á–∏—Å–ª—è—Ç—å –∑–∞–Ω–æ–≤–æ) (line 169-176)
- [x] –ï—Å–ª–∏ q_value=None ‚Üí fallback –∫ —Ç–µ–∫—É—â–µ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é (–¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤)

#### 1.6. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∂–∏–º–æ–≤ ‚úÖ
- [x] –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∂–∏–º: certified ‚Üí 'td3', relax ‚Üí 'relax', fallback ‚Üí 'fallback' (lines 303-320)
- [x] –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ modes –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ (line 336)
- [x] –û–±–Ω–æ–≤–ª—è—Ç—å self.action_sources –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ update_state)

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ ‚úÖ
- ‚úÖ `py -3.12 train_calf_visual.py` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ AttributeError ‚úÖ **VERIFIED**
- ‚úÖ –ü—Ä–æ—Ö–æ–¥–∏—Ç —à–∞–≥ 1000 –±–µ–∑ –æ—à–∏–±–æ–∫ ‚úÖ **IMPLEMENTED** (ready for full test)
- ‚è≥ FPS >= 60 (–±—ã–ª–æ ~30) - —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
- ‚è≥ GPU –≤—ã–∑–æ–≤–æ–≤ <= 10 per frame (–±—ã–ª–æ ~75) - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è (STAGE 4)

### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–°–º. –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä –≤ `../../PERFORMANCE_ANALYSIS.md` (—Å—Ç—Ä–æ–∫–∏ 332-442)

### –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] **‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º** (–±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ Stage 6)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π main.py
cd c:\GitHub\Learn\CALF\ursina
py -3.12 main.py

# 2. –î–æ–∂–¥–∞—Ç—å—Å—è —à–∞–≥–∞ 1000+ (–∫–æ–≥–¥–∞ training_started=True)
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ AttributeError
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ visual agents –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

---

## üéØ STAGE 2: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –í—ã—Å–æ–∫–∏–π (—É–¥–æ–±—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ COMPLETED
**–§–∞–π–ª—ã**: `ursina/config/` (training_config.py, visualization_config.py, app_config.py)
**–í—Ä–µ–º—è**: 1 —á–∞—Å

### –ü—Ä–æ–±–ª–µ–º–∞
–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ä–∞–∑–º–∞–∑–∞–Ω—ã –ø–æ –∫–æ–¥—É (TRAIL_MAX_LENGTH, HEATMAP_GRID_SIZE –∏ —Ç.–¥.)
–°–ª–æ–∂–Ω–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏, –Ω–µ—Ç –ø—Ä–µ—Å–µ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤.

### –ó–∞–¥–∞—á–∏ ‚úÖ

#### 2.1. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É config ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `ursina/config/` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞)
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/config/__init__.py` (–æ–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤—ã–º–∏ exports)
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/config/training_config.py` ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/config/visualization_config.py` ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/config/app_config.py` ‚úÖ

#### 2.2. TrainingConfig ‚úÖ
- [x] Dataclass —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –æ–±—É—á–µ–Ω–∏—è:
  - num_episodes, max_steps_per_episode, batch_size
  - exploration_noise, reward_scale, start_training_step
  - lambda_relax, nu_bar, kappa_low_coef, kappa_up_coef
- [x] –ú–µ—Ç–æ–¥ `from_preset(preset_name)` –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ ('quick', 'standard', 'thorough')

#### 2.3. VisualizationConfig ‚úÖ
- [x] Dataclass —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:
  - n_agents, trail_max_length, trail_decimation, trail_rebuild_freq
  - heatmap_enabled, heatmap_grid_size, heatmap_update_freq
  - grid_enabled, grid_node_size, grid_line_thickness
- [x] –ü—Ä–µ—Å–µ—Ç—ã: 'low', 'medium', 'high' –¥–ª—è —Ä–∞–∑–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [x] –ú–µ—Ç–æ–¥ `to_dict()` –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### 2.4. AppConfig ‚úÖ
- [x] –û–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –∫–ª–∞—Å—Å: training + visualization configs
- [x] –ú–µ—Ç–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ JSON —Ñ–∞–π–ª–∞ `from_file()` ‚úÖ
- [x] –ú–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ JSON —Ñ–∞–π–ª `to_file()` ‚úÖ
- [x] –ú–µ—Ç–æ–¥ `from_preset()` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–º–µ—à–∞–Ω–Ω—ã—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤
- [x] **BONUS**: –ú–µ—Ç–æ–¥ `to_dict()` –∏ `__repr__()` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü—Ä–µ—Å–µ—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
PRESETS = {
    'low': {  # –î–ª—è —Å–ª–∞–±—ã—Ö PC
        'n_agents': 10,
        'trail_length': 100,
        'heatmap_grid': 15,
        'heatmap_update_freq': 1000
    },
    'medium': {  # –ë–∞–ª–∞–Ω—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        'n_agents': 25,
        'trail_length': 200,
        'heatmap_grid': 21,
        'heatmap_update_freq': 500
    },
    'high': {  # –î–ª—è –º–æ—â–Ω—ã—Ö PC
        'n_agents': 50,
        'trail_length': 300,
        'heatmap_grid': 31,
        'heatmap_update_freq': 250
    }
}
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ ‚úÖ
- ‚úÖ –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ config ‚úÖ
- ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—Ä–µ—Å–µ—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π: `config = AppConfig.from_preset('high')` ‚úÖ
- ‚úÖ –õ–µ–≥–∫–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ‚úÖ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ (tests/test_config.py) ‚úÖ

### –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- [x] Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (tests/test_config.py - ALL PASSED)
- [ ] **‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º** (–±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ Stage 6)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
cd c:\GitHub\Learn\CALF\ursina
py -3.12 tests/test_config.py
# Result: [SUCCESS] ALL TESTS PASSED
```

–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã:
- Default config works
- Presets work (low, medium, high)
- Mixed presets work
- to_dict() works
- Individual configs work

---

## üéØ STAGE 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ main.py ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –í—ã—Å–æ–∫–∏–π (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ COMPLETED
**–§–∞–π–ª—ã**: `ursina/main.py` (–Ω–æ–≤—ã–π), `ursina/old_main.py`, `ursina/core/application.py`, `ursina/training/`
**–í—Ä–µ–º—è**: Completed

### –ü—Ä–æ–±–ª–µ–º–∞
- train_calf_visual.py - 974 —Å—Ç—Ä–æ–∫–∏, –≤—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ setup –∫–æ–¥–∞ –º–µ–∂–¥—É main.py –∏ train_calf_visual.py
- –°–ª–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ó–∞–¥–∞—á–∏ ‚úÖ

#### 3.1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π main.py ‚úÖ
- [x] `ursina/main.py` ‚Üí `ursina/old_main.py`
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–≤–µ—Ä—Ö—É: "Old main - kept for reference"

#### 3.2. –°–æ–∑–¥–∞—Ç—å CALFApplication builder ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `ursina/core/` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞)
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/core/application.py` —Å –∫–ª–∞—Å—Å–æ–º CALFApplication
- [x] –ú–µ—Ç–æ–¥—ã:
  - `__init__(config)` - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç AppConfig
  - `setup()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Ursina + –º–µ–Ω–µ–¥–∂–µ—Ä—ã + —Å—Ü–µ–Ω–∞
  - `create_training_env()` - factory –¥–ª—è training environment
  - `create_visual_envs(n_agents)` - factory –¥–ª—è visual environments
  - `update_managers()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
  - `run()` - –∑–∞–ø—É—Å–∫ app.run()

#### 3.3. –°–æ–∑–¥–∞—Ç—å Trainer ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `ursina/training/`
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/training/trainer.py` —Å –∫–ª–∞—Å—Å–æ–º CALFTrainer
- [x] –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –æ–±—É—á–µ–Ω–∏—è:
  - train_step() - –æ–¥–∏–Ω —à–∞–≥ –æ–±—É—á–µ–Ω–∏—è
  - should_train() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –æ–±—É—á–µ–Ω–∏—é
  - handle_episode_end() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ü–∞ —ç–ø–∏–∑–æ–¥–∞
  - get_stats() - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  - is_complete() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  - finalize() - —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- [x] –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: current_state, episode_reward, episode_length

#### 3.4. –°–æ–∑–¥–∞—Ç—å Visualizer ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/training/visualizer.py` —Å –∫–ª–∞—Å—Å–æ–º TrainingVisualizer
- [x] –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é:
  - update_visual_agents() - batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
  - update_heatmap() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ critic heatmap
  - update_stats_display() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  - update_training_agent() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
  - update_q_cert_timeline() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Q-certificate –≥—Ä–∞—Ñ–∏–∫–∞
- [x] –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ visual_envs + heatmap + UI text
- [x] **BONUS**: –í–∫–ª—é—á–µ–Ω –∫–ª–∞—Å—Å VisualAgent –¥–ª—è –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞ + —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏

#### 3.5. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π main.py ‚úÖ
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CALFApplication –¥–ª—è setup
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Trainer –¥–ª—è –ª–æ–≥–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Visualizer –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- [x] –ì–ª–æ–±–∞–ª—å–Ω–∞—è update() - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [x] –ì–ª–æ–±–∞–ª—å–Ω–∞—è input() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
- [x] –†–∞–∑–º–µ—Ä: 317 —Å—Ç—Ä–æ–∫ (–≤–º–µ—Å—Ç–æ 974) - **67% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ**

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–æ–≤–æ–≥–æ main.py

```python
# ursina/main.py
from config import AppConfig
from core import CALFApplication
from training import CALFTrainer, TrainingVisualizer

# Load config
config = AppConfig.from_preset('medium')

# Setup application
app = CALFApplication(config).setup()

# Create trainer
trainer = CALFTrainer(calf_agent, env, replay_buffer, config.training)

# Create visualizer
visualizer = TrainingVisualizer(
    visual_envs=visual_envs,
    heatmap=critic_heatmap,
    stats_text=stats_text,
    config=config.visualization
)

def update():
    """Main loop - coordinate components"""
    # Training
    if not trainer.paused:
        next_state, done = trainer.train_step()

        # Visualization
        visualizer.update_visual_agents(calf_agent.td3)
        visualizer.update_heatmap(trainer.total_steps)
        visualizer.update_stats(trainer.get_stats())

        if done:
            trainer.handle_episode_end()

    # Update managers
    app.update_managers()

def input(key):
    app.handle_input(key)

app.run()
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ ‚úÖ
- ‚úÖ main.py = 317 —Å—Ç—Ä–æ–∫ (–≤–º–µ—Å—Ç–æ 974 –≤ train_calf_visual.py) - **67% —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ**
- ‚úÖ –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: Application / Trainer / Visualizer
- ‚úÖ –õ–µ–≥–∫–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ old_main.py —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è reference
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ (python -m py_compile)

### –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω (py_compile)
- [ ] **‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º** (–±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ Stage 6)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π main.py
py -3.12 main.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤ train_calf_visual.py
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FPS, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é, –æ–±—É—á–µ–Ω–∏–µ
```

---

## üéØ STAGE 4: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –°—Ä–µ–¥–Ω–∏–π (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ COMPLETED
**–§–∞–π–ª—ã**: `ursina/utils/profiler.py`, –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ main.py
**–í—Ä–µ–º—è**: Completed

### –ü—Ä–æ–±–ª–µ–º–∞
–ù–µ –∑–Ω–∞–µ–º —Ç–æ—á–Ω–æ –≥–¥–µ bottleneck, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–Ω–∏–º–∞–µ—Ç –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.
–ù—É–∂–µ–Ω –¥–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

### –ó–∞–¥–∞—á–∏ ‚úÖ

#### 4.1. –°–æ–∑–¥–∞—Ç—å Profiler –∫–ª–∞—Å—Å ‚úÖ
- [x] –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `ursina/utils/` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞)
- [x] –°–æ–∑–¥–∞—Ç—å `ursina/utils/profiler.py` —Å –∫–ª–∞—Å—Å–æ–º PerformanceProfiler
- [x] Context manager –¥–ª—è –∑–∞–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏: `with profiler.measure('operation_name'):`
- [x] –•—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: min, max, avg, EMA
- [x] –ú–µ—Ç–æ–¥ `get_report()` –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞
- [x] **BONUS**: –ú–µ—Ç–æ–¥ `get_compact_report()` –¥–ª—è UI
- [x] **BONUS**: –ú–µ—Ç–æ–¥—ã `enable()`, `disable()`, `reset()` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### 4.2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ update() ‚úÖ
- [x] –ó–∞–º–µ—Ä—è—Ç—å –≤—Ä–µ–º—è –∫–∞–∂–¥–æ–π —Å–µ–∫—Ü–∏–∏:
  - Training step (trainer.train_step)
  - Training agent visualization
  - Episode end handling
  - Visual agents update (visualizer.update_visual_agents)
  - Heatmap update (visualizer.update_heatmap)
  - Stats display update
  - Managers update (app.update_managers)
  - Total frame time

#### 4.3. UI –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚úÖ
- [x] –î–æ–±–∞–≤–∏—Ç—å Text —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è (bottom-right)
- [x] –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 60 –∫–∞–¥—Ä–æ–≤ (~1 —Å–µ–∫—É–Ω–¥—É)
- [x] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ø-5 —Å–∞–º—ã—Ö –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è: [+] (<5ms), [!] (5-10ms), [X] (>10ms)

#### 4.4. –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π ‚úÖ
- [x] –ú–µ—Ç–æ–¥ `profiler.export_to_csv(filename)` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- [x] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –Ω–∞–∂–∞—Ç–∏—é F1
- [x] –§–æ—Ä–º–∞—Ç: timestamp, operation, duration_ms
- [x] **BONUS**: F2 –¥–ª—è toggle profiler on/off
- [x] **BONUS**: F3 –¥–ª—è reset —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
# –í update()
with profiler.measure('physics'):
    simulation_engine.update_all()

with profiler.measure('training'):
    next_state, done = trainer.train_step()

with profiler.measure('visual_agents'):
    visualizer.update_visual_agents(policy)

# –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç
if frame_counter % 60 == 0:
    report = profiler.get_report()
    performance_text.text = report
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ ‚úÖ
- ‚úÖ –í–∏–¥–∏–º –≤—Ä–µ–º—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ‚úÖ
- ‚úÖ –ú–æ–∂–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ ‚úÖ
- ‚úÖ –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ bottleneck ‚úÖ
- ‚úÖ Overhead –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è < 1ms ‚úÖ (0.001ms per measurement)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
```bash
# Unit tests
py -3.12 tests/test_profiler.py
# Result: 7 passed, 0 failed

# Overhead –∏–∑–º–µ—Ä–µ–Ω: 0.001ms per measurement (1000 measurements in 1.41ms)
# CSV export —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `ursina/utils/profiler.py` (304 lines) - PerformanceProfiler class
- `ursina/tests/test_profiler.py` (196 lines) - Unit tests
- `ursina/main.py` - –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä —Å UI –∏ –∫–ª–∞–≤–∏—à–∞–º–∏ F1/F2/F3

### –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- [x] Unit-—Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (7/7)
- [ ] **‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º** (–û–ñ–ò–î–ê–ï–¢!)

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `py -3.12 main.py`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è (bottom-right corner)
3. –î–æ–∂–¥–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (~1 —Å–µ–∫—É–Ω–¥–∞)
4. –ù–∞–∂–∞—Ç—å F1 - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ CSV —Ñ–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
5. –ù–∞–∂–∞—Ç—å F2 - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è/–≤–∫–ª—é—á–∞–µ—Ç—Å—è
6. –ù–∞–∂–∞—Ç—å F3 - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è

---

## üéØ STAGE 5: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ ‚úÖ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –°—Ä–µ–¥–Ω–∏–π (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ COMPLETED
**–§–∞–π–ª—ã**: `ursina/visuals/line_trail.py`, `ursina/visuals/critic_heatmap.py`, `ursina/training/visualizer.py`
**–í—Ä–µ–º—è**: Completed

### –ü—Ä–æ–±–ª–µ–º–∞
–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –∏ heatmap –º–æ–≥—É—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∞–≥–µ–Ω—Ç–æ–≤.
–ù—É–∂–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è rebuild —á–∞—Å—Ç–æ—Ç—ã –∏ batch –æ–ø–µ—Ä–∞—Ü–∏–π.

### –ó–∞–¥–∞—á–∏ ‚úÖ

#### 5.1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è LineTrail ‚úÖ
- [x] –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `rebuild_freq` –¥–ª—è —Ä–µ–¥–∫–∏—Ö –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–∫ (–∫–∞–∂–¥—ã–µ N –¥–æ–±–∞–≤–ª–µ–Ω–∏–π)
- [x] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å `_group_by_mode()` —á–µ—Ä–µ–∑ numpy –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
- [x] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ mesh –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π (`needs_rebuild` —Ñ–ª–∞–≥)
- [x] –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ –≤ `_rebuild_segments()`
- [x] –°—á—ë—Ç—á–∏–∫ `rebuild_counter` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —á–∞—Å—Ç–æ—Ç—ã

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `__init__`: –î–æ–±–∞–≤–ª–µ–Ω—ã `rebuild_freq`, `rebuild_counter`, `needs_rebuild`
- `add_point`: –ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–ª—å–∫–æ –∫–∞–∂–¥—ã–µ `rebuild_freq` –¥–æ–±–∞–≤–ª–µ–Ω–∏–π (–≤–º–µ—Å—Ç–æ –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞)
- `_group_by_mode`: –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å numpy (–≤–º–µ—Å—Ç–æ Python —Ü–∏–∫–ª–∞)
- `_rebuild_segments`: –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Ç–æ—á–µ–∫, –ø—Ä–æ–≤–µ—Ä–∫–∞ `needs_rebuild`
- `apply_transform`: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `needs_rebuild = True`
- `clear`: –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤

#### 5.2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CriticHeatmap ‚úÖ
- [x] Batch –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ Q-–∑–Ω–∞—á–µ–Ω–∏–π —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ–¥–∏–Ω forward pass)
- [x] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Q-grid –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ (`q_values_cached`, `cache_valid`)
- [x] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞ –≤ `_interpolate_q_from_grid()` –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
- [x] –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –≤ `clear()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `__init__`: –î–æ–±–∞–≤–ª–µ–Ω—ã `q_values_cached`, `cache_valid`
- `_compute_q_values`: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Q-values –ø–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- `_interpolate_q_from_grid`: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Q-values
- `clear`: –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è - —Ç–µ–∫—É—â–∏–π batch –ø–æ–¥—Ö–æ–¥ —É–∂–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω.

#### 5.3. Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∞–≥–µ–Ω—Ç–æ–≤ ‚úÖ
- [x] Batch –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ heights —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (`get_agent_heights_batch`)
- [x] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø–æ–ª—É—á–µ–Ω–∏–µ zoom transform –æ–¥–∏–Ω —Ä–∞–∑ (–≤–º–µ—Å—Ç–æ N —Ä–∞–∑ –≤ —Ü–∏–∫–ª–µ)
- [x] –ò–∑–±–µ–∂–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö lookups –≤ zoom_manager

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `update_visual_agents`: –ü–æ–ª—É—á–µ–Ω–∏–µ `a_trans` –∏ `b_trans` –æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ —Ü–∏–∫–ª–æ–º (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω)

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚è≥ FPS —Å—Ç–∞–±–∏–ª–µ–Ω –ø—Ä–∏ 50+ –∞–≥–µ–Ω—Ç–∞—Ö (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞)
- ‚è≥ Heatmap update < 5ms (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞)
- ‚è≥ Trail rebuild —É–ª—É—á—à–µ–Ω –∑–∞ —Å—á—ë—Ç rebuild_freq

### –°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [x] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] **‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º** (–û–ñ–ò–î–ê–ï–¢!)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–æ–º
py -3.12 main.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FPS –∏ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–µ
# –ù–∞–∂–∞—Ç—å F1 –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `py -3.12 main.py`
2. –î–æ–∂–¥–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–∞ (~1 —Å–µ–∫—É–Ω–¥–∞)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–π (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ —á–µ–º —Ä–∞–Ω—å—à–µ)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FPS (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ ~47 FPS)
5. –ù–∞–∂–∞—Ç—å F1 –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–∞

---

## üéØ STAGE 6: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –°—Ä–µ–¥–Ω–∏–π (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
**–°—Ç–∞—Ç—É—Å**: ‚è≥ Not Started
**–§–∞–π–ª—ã**: README.md, —Ç–µ—Å—Ç—ã, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
**–í—Ä–µ–º—è**: ~1-2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏

#### 6.1. –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å train_calf_visual.py (—Å—Ç–∞—Ä—ã–π –∫–æ–¥) - –∑–∞–º–µ—Ä–∏—Ç—å FPS
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å main.py (–Ω–æ–≤—ã–π –∫–æ–¥) - –∑–∞–º–µ—Ä–∏—Ç—å FPS
- [ ] –°—Ä–∞–≤–Ω–∏—Ç—å GPU –≤—ã–∑–æ–≤—ã (—á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
- [ ] –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ

#### 6.2. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –û–±–Ω–æ–≤–∏—Ç—å ursina/README.md (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é "Performance" —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### 6.3. –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å `ursina/llm/stage_2/FINAL_REPORT.md`
- [ ] –¢–∞–±–ª–∏—Ü–∞: –¥–æ/–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- [ ] –°–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
- [ ] –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ TODO –¥–ª—è Stage 3

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ –í—Å–µ 6 —Å—Ç–∞–¥–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- ‚úÖ FPS —É–ª—É—á—à–µ–Ω –º–∏–Ω–∏–º—É–º –≤ 2x
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –≤—Å–µ–≥–æ Stage 2

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ Stage 2 | –¶–µ–ª—å | –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ |
|---------|-----------|------|------------|
| FPS (25 agents) | ~30 | 60-120 | ? |
| GPU calls/frame | ~75 | ‚â§10 | ? |
| Train step time | ~32ms | ‚â§2ms | ? |
| Heatmap update | ~15ms | ‚â§5ms | ? |
| Lines of code (main) | 974 | ‚â§150 | ? |

---

**–ù–∞—á–Ω–∏ —Å–æ STAGE 1 –∏ –¥–≤–∏–≥–∞–π—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ!**
